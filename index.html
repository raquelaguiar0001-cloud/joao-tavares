<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UE. JO√ÉO TAVARES DA COSTA</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/197/197374.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Orbitron:wght@700&display=swap');
        
        * { box-sizing: border-box; transition: all 0.2s ease; }
        
        body { 
            font-family: 'Fredoka', sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
            background: #f8f0fb;
            overflow: hidden; color: #2e004f;
        }

        header { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 12px; margin: 8px; border-radius: 20px;
            border: 2px solid #ce93d8; z-index: 10; flex-shrink: 0;
        }

        .header-main { display: flex; justify-content: space-between; align-items: center; }
        .school-info h2 { margin: 0; font-family: 'Orbitron'; font-size: 17px; color: #6a1b9a; }

        .status-bar { 
            display: flex; gap: 12px; margin-top: 8px; font-size: 11px; font-weight: bold;
        }

        .nav-container { display: flex; gap: 6px; margin-top: 10px; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: #f0e1f7; color: #6a1b9a; font-weight: 700; cursor: pointer; border-radius: 10px; font-size: 10px; }
        .nav-btn.active { background: #ab47bc; color: white; }

        .main-content { display: flex; flex: 1; padding: 8px; gap: 10px; overflow: hidden; }
        
        .students-area { width: 580px; display: flex; flex-direction: column; overflow-y: auto; height: 100%; border-right: 1px solid #e1bee7; }
        
        .student-card { 
            background: white; margin-bottom: 2px; padding: 10px 15px; 
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .stu-name { font-weight: 800; font-size: 13px; text-transform: uppercase; display: block; margin-bottom: 6px; }

        /* GRID DE VISTOS */
        .check-grid { display: flex; gap: 3px; }
        .check-box { 
            width: 24px; height: 24px; border: 1px solid #ddd; border-radius: 5px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-size: 9px; font-weight: bold;
        }
        .check-box.active { background: #4caf50; color: white; border-color: #388e3c; }

        /* INPUTS DE CRIT√âRIOS (DIN√ÇMICOS POR LETRA INICIAL) */
        .criteria-inputs { display: flex; gap: 12px; align-items: center; }
        .crit-item { display: flex; flex-direction: column; align-items: center; }
        .crit-label { font-size: 11px; font-weight: 900; color: #c2185b; margin-bottom: 2px; }
        .in-score { 
            width: 48px; height: 40px; border: 2px solid #e0e0e0; border-radius: 10px; 
            text-align: center; font-size: 16px; font-weight: bold;
        }

        .final-box { min-width: 55px; text-align: center; }
        .final-val { font-size: 22px; font-weight: 900; display: block; }
        .annual-val { font-size: 10px; color: #888; }

        .track-container { flex: 1; background: #fffcf2; border-radius: 20px; overflow-y: auto; position: relative; }
        .lane { height: 50px; border-bottom: 1px solid #f0e1f7; position: relative; display: flex; align-items: center; }
        .runner { position: absolute; transition: left 1.5s ease; display: flex; align-items: center; gap: 5px; }
        .runner-tag { background: #6a1b9a; color: white; padding: 3px 10px; border-radius: 10px; font-size: 9px; white-space: nowrap; }

        .config-overlay { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; padding: 20px; width: 90%; max-width: 400px; z-index: 1000; display: none; border: 4px solid #ab47bc; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #loading { position: fixed; inset: 0; background: #f3e5f5; display: flex; align-items: center; justify-content: center; z-index: 9999; font-family: 'Orbitron'; color: #6a1b9a; }
    </style>
</head>
<body onclick="fecharTodos()">

<div id="loading"><b>CARREGANDO DADOS...</b></div>

<header onclick="event.stopPropagation()">
    <div class="header-main">
        <div class="school-info">
            <h2>UE. JO√ÉO TAVARES DA COSTA</h2>
            <div class="status-bar">
                <span>TURMA: <span id="txt-turma">--</span></span>
                <span>MAT√âRIA: <span id="txt-materia">--</span></span>
            </div>
        </div>
        <button onclick="exportarExcelCompleto()" style="background:#2e7d32; color:white; border:none; padding:8px 12px; border-radius:8px; font-weight:bold; cursor:pointer;">EXCEL</button>
    </div>
    <nav class="nav-container">
        <button class="nav-btn" onclick="abrirPainel('p-turmas')">TURMAS</button>
        <button class="nav-btn" onclick="abrirPainel('p-alunos')">ALUNOS</button>
        <button class="nav-btn" onclick="abrirPainel('p-crit')">CRIT√âRIOS</button>
        <div id="bim-tabs" style="display:flex; gap:4px; margin-left:auto;"></div>
    </nav>
</header>

<main class="main-content">
    <aside class="students-area" id="stu-list"></aside>
    <section class="track-container" id="lanes-box"></section>
</main>

<div id="p-turmas" class="config-overlay" onclick="event.stopPropagation()">
    <h3>Gerenciar Turmas</h3>
    <div id="class-list-del"></div>
    <input type="text" id="in-cl" placeholder="+ Nova Turma" onkeypress="if(event.key==='Enter') addT()" style="width:100%; padding:10px; margin-top:10px;">
</div>

<div id="p-alunos" class="config-overlay" onclick="event.stopPropagation()">
    <h3>Alunos</h3>
    <textarea id="in-nm" placeholder="Nomes (um por linha)..." style="width:100%; height:100px;"></textarea>
    <button onclick="addStus()" style="width:100%; background:#6a1b9a; color:white; padding:10px; margin-top:5px; border-radius:8px;">ADICIONAR</button>
    <div id="stu-list-del" style="max-height:150px; overflow-y:auto; margin-top:10px;"></div>
</div>

<div id="p-crit" class="config-overlay" onclick="event.stopPropagation()">
    <h3>Crit√©rios e Provas</h3>
    <p style="font-size:11px;">O sistema usar√° a <b>letra inicial</b> de cada crit√©rio.</p>
    <div id="crit-list-del"></div>
    <input type="text" id="in-cr" placeholder="+ Novo Crit√©rio (Ex: Prova)" onkeypress="if(event.key==='Enter') addC()" style="width:100%; padding:10px; margin-top:10px;">
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAXIOrHsZbHXvOIGTk0HS8NOwVBvpmwrOo",
        authDomain: "ue-joao-tavares-da-costa.firebaseapp.com",
        databaseURL: "https://ue-joao-tavares-da-costa-default-rtdb.firebaseio.com",
        projectId: "ue-joao-tavares-da-costa",
        storageBucket: "ue-joao-tavares-da-costa.firebasestorage.app",
        messagingSenderId: "879518153821",
        appId: "1:879518153821:web:282a71916d6b1e9199a1b4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let dados = { turmas: [], ti: 0, bim: 1 };

    db.ref('biolab_joao_tavares').on('value', (snap) => {
        if(snap.val()) dados = snap.val();
        // Garantir crit√©rio de Prova se n√£o existir
        const t = dados.turmas[dados.ti];
        if(t && t.crits && t.crits[t.mi]) {
            let temProva = t.crits[t.mi].some(c => c.n.toLowerCase().startsWith('p'));
            if(!temProva) { t.crits[t.mi].push({n: 'Provas'}); salvar(); }
        }
        document.getElementById('loading').style.display = 'none';
        renderizar();
    });

    function salvar() { db.ref('biolab_joao_tavares').set(dados); }
    function fecharTodos() { document.querySelectorAll('.config-overlay').forEach(p => p.style.display = 'none'); }
    function abrirPainel(id) { fecharTodos(); document.getElementById(id).style.display = 'block'; }

    function getNota(aluno, bim, mIdx) {
        const t = dados.turmas[dados.ti]; if(!t) return 0;
        let kA = `${mIdx}_${bim}_ativ`, totA = (t.totA && t.totA[mIdx]) || 10;
        if (!aluno.sc) aluno.sc = {};
        
        // Vistos (m√°ximo 10)
        let nVistos = ((aluno.sc[kA] || []).length / totA) * 10;
        
        // Outros Crit√©rios (Provas, Comportamento, etc)
        let somaExtras = 0;
        let crits = (t.crits && t.crits[mIdx]) || [];
        crits.forEach(c => {
            let letra = c.n.charAt(0).toUpperCase();
            somaExtras += parseFloat(aluno.sc[`${mIdx}_${bim}_${letra}`] || 0);
        });

        let media = (nVistos + somaExtras) / (crits.length + 1);
        return isNaN(media) ? 0 : media;
    }

    function renderizar() {
        const t = dados.turmas[dados.ti];
        if(!t) return;

        document.getElementById('txt-turma').innerText = t.n;
        document.getElementById('txt-materia').innerText = t.mats[t.mi];

        // RENDER ALUNOS
        document.getElementById('stu-list').innerHTML = (t.st || []).map((s, si) => {
            let nB = getNota(s, dados.bim, t.mi);
            let nAnual = (getNota(s,1,t.mi)+getNota(s,2,t.mi)+getNota(s,3,t.mi)+getNota(s,4,t.mi))/4;
            
            // Vistos
            let kA = `${t.mi}_${dados.bim}_ativ`, chs = '', tot = (t.totA && t.totA[t.mi]) || 10;
            for(let i=0; i<tot; i++) {
                chs += `<div class="check-box ${(s.sc?.[kA]||[]).includes(i)?'active':''}" onclick="tglV(${si},'${kA}',${i})">${i+1}</div>`;
            }

            // Crit√©rios Din√¢micos (Letra Inicial)
            let inputsCrit = (t.crits?.[t.mi] || []).map(c => {
                let letra = c.n.charAt(0).toUpperCase();
                return `
                <div class="crit-item">
                    <span class="crit-label">${letra}</span>
                    <input type="number" step="0.1" class="in-score" 
                        value="${s.sc?.[`${t.mi}_${dados.bim}_${letra}`]||0}" 
                        onchange="upN(${si},'${t.mi}_${dados.bim}_${letra}',this.value)">
                </div>`;
            }).join('');

            return `
            <div class="student-card">
                <div>
                    <span class="stu-name">${s.n}</span>
                    <div class="check-grid">${chs}</div>
                </div>
                <div class="criteria-inputs">${inputsCrit}</div>
                <div class="final-box">
                    <span class="final-val" style="color:${nB<7?'#ff4757':'#2ecc71'}">${nB.toFixed(1)}</span>
                    <span class="annual-val">An: ${nAnual.toFixed(1)}</span>
                </div>
            </div>`;
        }).join('');

        // CORRIDA
        const lanes = document.getElementById('lanes-box'); lanes.innerHTML = '';
        (t.st || []).forEach((s, i) => {
            let n = getNota(s, dados.bim, t.mi);
            lanes.innerHTML += `<div class="lane">
                <div class="runner" style="left:${n*9}%">
                    <span style="font-size:20px;">üèÉ</span>
                    <div class="runner-tag">${s.n} | ${n.toFixed(1)}</div>
                </div>
            </div>`;
        });

        // BIMS
        document.getElementById('bim-tabs').innerHTML = [1,2,3,4].map(b => `<button class="nav-btn ${b===dados.bim?'active':''}" onclick="dados.bim=${b};salvar()">${b}¬∫ BIM</button>`).join('');
    }

    function tglV(si, k, idx) { 
        let s=dados.turmas[dados.ti].st[si]; if(!s.sc) s.sc={}; if(!s.sc[k]) s.sc[k]=[]; 
        let p=s.sc[k].indexOf(idx); if(p>-1) s.sc[k].splice(p,1); else s.sc[k].push(idx); 
        salvar(); 
    }
    function upN(si, k, v) { if(!dados.turmas[dados.ti].st[si].sc) dados.turmas[dados.ti].st[si].sc={}; dados.turmas[dados.ti].st[si].sc[k] = parseFloat(v); salvar(); }
    
    function addC() { 
        let v=document.getElementById('in-cr').value; 
        if(v){ 
            const t=dados.turmas[dados.ti]; 
            if(!t.crits[t.mi]) t.crits[t.mi]=[]; 
            t.crits[t.mi].push({n:v}); 
            salvar(); document.getElementById('in-cr').value=''; 
        } 
    }
    
    // Fun√ß√µes extras de Turma e Aluno (Preservadas)
    function addT() { let v=document.getElementById('in-cl').value; if(v){ if(!dados.turmas) dados.turmas=[]; dados.turmas.push({n:v, mats:['Ingl√™s'], mi:0, totA:[10], crits:[[{n:'Comportamento'},{n:'Provas'}]], st:[]}); salvar(); } }
    function addStus() { 
        let n=document.getElementById('in-nm').value.split('\n'); 
        n.forEach(x=>{ if(x.trim()) { if(!dados.turmas[dados.ti].st) dados.turmas[dados.ti].st=[]; dados.turmas[dados.ti].st.push({n:x.trim(), sc:{}}); } }); 
        dados.turmas[dados.ti].st.sort((a,b)=>a.n.localeCompare(b.n));
        salvar(); 
    }
</script>
</body>
</html>
